<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ötscher Buchungs-Widget</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body{
      margin:0; background:#f4f6f9; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:flex; align-items:flex-start; justify-content:center; padding:24px;
    }
    #oe-widget{ max-width:720px; width:100%; background:#fff; border:1px solid #e6e6e9; border-radius:14px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .oe-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .oe-title{ margin:0; font-size:22px; font-weight:800; line-height:1.2; }
    .oe-subtitle{ color:#6b7280; font-size:14px; }
    .oe-logo{ height:40px; width:auto; object-fit:contain; }
    .oe-body{ display:flex; gap:16px; flex-wrap:wrap; min-width:0; }
    .oe-section{ flex:1 1 300px; border:1px solid #ececf1; border-radius:12px; padding:14px; min-width:0; }
    .oe-section-title{ font-weight:600; margin-bottom:10px; }
    .oe-daterow{ display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr); gap:10px; align-items:end; width:100%; }
    .oe-datefield label{ display:block; font-size:12px; color:#6b7280; margin:0 0 4px 0; line-height:1.2; }
    input[type="date"]{ width:100%; padding:10px; border:1px solid #d1d5db; border-radius:12px; background:#fff; color:#111827; font-size:14px; }
    .oe-hint{ margin-top:8px; color:#6b7280; font-size:12px; }
    .oe-duration{ margin-top:8px; font-size:13px; color:#111827; font-weight:600; }
    .oe-counters{ display:flex; flex-direction:column; gap:8px; }
    .oe-counter-row{ display:grid; grid-template-columns:40px 1fr auto; gap:10px; align-items:center; border:1px solid #ececf1; border-radius:12px; padding:12px; }
    .oe-count{ font-size:24px; font-weight:800; color:#111827; min-width:28px; text-align:center; }
    .oe-label{ font-weight:700; }
    .oe-sublabel{ color:#6b7280; font-size:12px; }
    .oe-actions{ display:flex; gap:8px; }
    .oe-btn{ width:36px; height:36px; border-radius:10px; border:1px solid #d1d5db; background:#fff; font-size:18px; line-height:34px; text-align:center; cursor:pointer; }
    .oe-btn:disabled{ opacity:.35; cursor:not-allowed; }
    .oe-error{ margin-top:8px; color:#b00020; font-size:14px; }
    .oe-footer{ margin-left:auto; margin-top:8px; }
    .oe-cta{ padding:12px 18px; border-radius:12px; border:0; background:#154696; color:#fff; font-weight:700; cursor:pointer; min-width:140px; }
    .oe-cta:hover{ background:#103874; }
    @media (max-width:510px){ .oe-daterow{ grid-template-columns:1fr; } .oe-logo{ height:32px; } }
  </style>
</head>
<body>

  <div id="oe-widget">
    <div class="oe-header">
      <div class="oe-titles">
        <h3 class="oe-title"></h3>
        <div class="oe-subtitle"></div>
      </div>
      <img class="oe-logo" src="https://raw.githubusercontent.com/MarketingHOT/hot_assets/refs/heads/main/logo_rgb_oetscher.png" alt="">
    </div>

    <div class="oe-body">
      <div class="oe-section" id="oe-date-section">
        <div class="oe-section-title" id="i18n-date-section"></div>

        <div class="oe-daterow">
          <div class="oe-datefield">
            <label for="oe-start" id="i18n-from"></label>
            <input type="date" id="oe-start" required>
          </div>
          <div class="oe-datefield">
            <label for="oe-end" id="i18n-to"></label>
            <input type="date" id="oe-end" placeholder="optional" disabled>
          </div>
        </div>

        <div class="oe-hint" id="i18n-hint"></div>
        <div class="oe-duration" id="oe-duration"></div>
      </div>

      <div class="oe-section oe-counters">
        <div class="oe-counter-row">
          <div class="oe-count" id="oe-adults-count">1</div>
          <div class="oe-labels">
            <div class="oe-label" id="i18n-adult"></div>
            <div class="oe-sublabel" id="i18n-adult-age"></div>
          </div>
          <div class="oe-actions">
            <button class="oe-btn oe-minus" id="oe-adults-minus" type="button">–</button>
            <button class="oe-btn oe-plus"  id="oe-adults-plus"  type="button">+</button>
          </div>
        </div>

        <div class="oe-counter-row">
          <div class="oe-count" id="oe-kids-count">0</div>
          <div class="oe-labels">
            <div class="oe-label" id="i18n-child"></div>
            <div class="oe-sublabel" id="i18n-child-age"></div>
          </div>
          <div class="oe-actions">
            <button class="oe-btn oe-minus" id="oe-kids-minus" type="button" disabled>–</button>
            <button class="oe-btn oe-plus"  id="oe-kids-plus"  type="button">+</button>
          </div>
        </div>
      </div>

      <div id="oe-error" class="oe-error" style="display:none"></div>
      <div class="oe-footer"><button id="oe-submit" class="oe-cta" type="button"></button></div>
    </div>
  </div>

  <script>
    /* ---------- i18n (DE/EN via ?lang=, Fallback Browser) ---------- */
    const I18N = {
      de: {
        title:"Skitickets", subtitle:"Stunden-, Tages- & Mehrtagestickets",
        date_section:"Datumsbereich", from:"Von", to:"Bis",
        hint:"Buchbar sind 1–6 Tage. „Bis“ leer lassen, um 1 Tag zu buchen.",
        selected_duration:"Ausgewählte Dauer: {d} {day}",
        day_one:"Tag", day_other:"Tage",
        adult:"Erwachsen", adult_age:"Alter ab 16 Jahren",
        child:"Kind", child_age:"Alter zwischen 6 und 15 Jahren",
        error_start:"Bitte ein Startdatum wählen.",
        error_duration:"Bitte eine Dauer zwischen 1 und 6 Tagen wählen.",
        cta:"Weiter", logo_alt:"Ötscher Logo", date_unset:"Ausgewählte Dauer: –"
      },
      en: {
        title:"Ski tickets", subtitle:"Hourly, Day & Multi-day tickets",
        date_section:"Date range", from:"From", to:"To",
        hint:"Bookable for 1–6 days. Leave “To” empty to book 1 day.",
        selected_duration:"Selected duration: {d} {day}",
        day_one:"day", day_other:"days",
        adult:"Adult", adult_age:"Age 16 and over",
        child:"Child", child_age:"Age 6 to 15",
        error_start:"Please select a start date.",
        error_duration:"Please choose a duration between 1 and 6 days.",
        cta:"Continue", logo_alt:"Ötscher logo", date_unset:"Selected duration: –"
      }
    };

    function detectLang(){
      const qp = new URLSearchParams(location.search).get('lang');
      if (qp) return qp.split('-')[0].toLowerCase();
      const nav = (navigator.language || 'de').toLowerCase();
      return nav.startsWith('en') ? 'en' : 'de';
    }
    let LANG = detectLang();
    document.documentElement.lang = LANG;

    function t(k){ return (I18N[LANG] && I18N[LANG][k]) || I18N.de[k] || k; }
    function plural(n,one,other){ return n===1 ? t(one) : t(other); }

    function applyI18n(){
      document.querySelector('.oe-title').textContent = t('title');
      document.querySelector('.oe-subtitle').textContent = t('subtitle');
      const logo = document.querySelector('.oe-logo'); if (logo) logo.alt = t('logo_alt');
      document.getElementById('i18n-date-section').textContent = t('date_section');
      document.getElementById('i18n-from').textContent = t('from');
      document.getElementById('i18n-to').textContent = t('to');
      document.getElementById('i18n-hint').textContent = t('hint');
      document.getElementById('i18n-adult').textContent = t('adult');
      document.getElementById('i18n-adult-age').textContent = t('adult_age');
      document.getElementById('i18n-child').textContent = t('child');
      document.getElementById('i18n-child-age').textContent = t('child_age');
      document.getElementById('oe-submit').textContent = t('cta');
      document.getElementById('oe-duration').textContent = t('date_unset');
    }
    document.addEventListener('DOMContentLoaded', applyI18n);
  </script>

  <script>
  (function(){
    const MAX_DAYS = 6;
    const qs = new URLSearchParams(location.search);

    const $ = id => document.getElementById(id);
    const elStart = $("oe-start"), elEnd = $("oe-end"), err = $("oe-error"), dur = $("oe-duration");

    let adults = 1, kids = 0;
    function setCount(type, v){
      v = Math.max(0, Math.min(99, v|0));
      if (type === "adults"){ adults = v; $("oe-adults-count").textContent = v; }
      else { kids = v; $("oe-kids-count").textContent = v; $("oe-kids-minus").disabled = v <= 0; }
    }
    $("oe-adults-minus").onclick = () => setCount("adults", adults - 1);
    $("oe-adults-plus").onclick  = () => setCount("adults", adults + 1);
    $("oe-kids-minus").onclick   = () => setCount("kids", kids - 1);
    $("oe-kids-plus").onclick    = () => setCount("kids", kids + 1);

    function toISODate(d){ return new Date(d).toISOString().split("T")[0]; }
    function addDaysISO(iso,n){ const dt = new Date(iso); dt.setDate(dt.getDate()+n); return toISODate(dt); }
    function diffDays(s,e){ return Math.round((new Date(e)-new Date(s))/86400000)+1; }
    function clampDate(v,min,max){ if(!v)return v; if(min&&v<min)return min; if(max&&v>max)return max; return v; }
    function toISO(dtStr, end){ return new Date(dtStr + (end ? "T23:59:59.999" : "T00:00:00")).toISOString(); }

    function syncConstraints(){
      const s = elStart.value;
      if (!s){ elEnd.value=""; elEnd.disabled=true; dur.textContent=t("date_unset"); return; }
      elEnd.disabled=false; elEnd.min=s; elEnd.max=addDaysISO(s, MAX_DAYS-1);
      elEnd.value = clampDate(elEnd.value || s, elEnd.min, elEnd.max);
      updateDuration();
    }
    function updateDuration(){
      const s = elStart.value; const e = elEnd.value || s;
      if (!s){ dur.textContent = t("date_unset"); return; }
      let d = diffDays(s, e);
      if (d < 1) { d = 1; elEnd.value = s; }
      if (d > MAX_DAYS) { d = MAX_DAYS; elEnd.value = addDaysISO(s, MAX_DAYS-1); }
      dur.textContent = t("selected_duration")
        .replace("{d}", d)
        .replace("{day}", plural(d, "day_one", "day_other"));
    }
    ["input","change","blur"].forEach(evt=>{
      elStart.addEventListener(evt, syncConstraints);
      elEnd.addEventListener(evt, () => { if (elStart.value){ elEnd.min=elStart.value; elEnd.max=addDaysISO(elStart.value, MAX_DAYS-1); elEnd.value=clampDate(elEnd.value, elEnd.min, elEnd.max); } updateDuration(); });
    });

    // ---------- Shop-URL Builder (sprach- & produktabhängig, mit UTM) ----------
    function buildShopUrl(formState, days){
      const isMulti = days > 1;
      // Basis-Path je Sprache & Produkt
      const base = (LANG === 'en')
        ? (isMulti ? 'https://shop.oetscher.at/en/products/skitickets-pool' : 'https://shop.oetscher.at/en/products/skitickets')
        : (isMulti ? 'https://shop.oetscher.at/products/skitickets-pool'    : 'https://shop.oetscher.at/products/skitickets');

      const url = new URL(base);

      // Defaults gem. Vorgabe
      const UTM_DEFAULT = {
        utm_source:   'referral',
        utm_medium:   'widget',
        utm_campaign: 'oet',
        utm_content:  'undefined'
      };

      // iFrame-Overrides erlauben (utm_*)
      const utms = { ...UTM_DEFAULT };
      ['utm_source','utm_medium','utm_campaign','utm_content'].forEach(k=>{
        if (qs.get(k)) utms[k] = qs.get(k);
      });

      Object.entries(utms).forEach(([k,v])=>url.searchParams.set(k,v));
      url.searchParams.set('formState', JSON.stringify(formState));
      return url.toString();
    }

    $("oe-submit").onclick = () => {
      err.style.display = "none";
      const s = elStart.value;
      if (!s){ err.textContent = t("error_start"); err.style.display="block"; return; }
      syncConstraints(); updateDuration();

      const e = elEnd.value || s;
      const d = diffDays(s, e);
      if (d < 1 || d > MAX_DAYS){ err.textContent = t("error_duration"); err.style.display="block"; return; }

      const formState = {
        validity: { from: toISO(s,false), to: toISO(e,true) },
        allocation: {
          kind: "persontype",
          values: [
            { kind:"anonymous", quantity: parseInt(document.getElementById("oe-adults-count").textContent,10)||0, personType:"adult" },
            { kind:"anonymous", quantity: parseInt(document.getElementById("oe-kids-count").textContent,10)||0,   personType:"child" }
          ].filter(v=>v.quantity>0)
        },
        attributes: { duration: d===1 ? "1d" : (d+"d") }
      };

      window.open(buildShopUrl(formState, d), "_blank", "noopener");
    };

    // defaults
    setCount("adults",1); setCount("kids",0);
  })();
  </script>

  <script>
  // --- iFrame Auto-Resize (OEWIDGET_HEIGHT) ---
  (function(){
    var ROOT = document.getElementById('oe-widget');
    var BODY_PADDING = 48; // 24 + 24
    function calcHeight(){ return Math.ceil(ROOT.getBoundingClientRect().height) + BODY_PADDING; }
    function post(reason){ try{ parent.postMessage({ type:'OEWIDGET_HEIGHT', height: calcHeight(), reason: reason||'' }, '*'); }catch(e){} }
    window.addEventListener('load',  function(){ post('load');  });
    window.addEventListener('resize',function(){ post('resize');});
    var mo = new MutationObserver(function(){ clearTimeout(post._t); post._t = setTimeout(function(){ post('mut'); }, 50); });
    mo.observe(ROOT, { subtree:true, childList:true, attributes:true });
    setTimeout(function(){ post('delay300'); }, 300);
    setTimeout(function(){ post('delay1200'); }, 1200);
  })();
  </script>
</body>
</html>
