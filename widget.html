<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hochkar Buchungs-Widget</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body{
      margin:0;
      background:#f4f6f9;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px;
    }
    #hk-widget{
      max-width:720px;
      width:100%;
      background:#fff;
      border:1px solid #e6e6e9;
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .hk-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
    }
    .hk-title{ margin:0; font-size:22px; font-weight:800; line-height:1.2; }
    .hk-subtitle{ color:#6b7280; font-size:14px; }
    .hk-logo{ height:40px; width:auto; object-fit:contain; }
    .hk-body{ display:flex; gap:16px; flex-wrap:wrap; min-width:0; }
    .hk-section{
      flex:1 1 300px;
      border:1px solid #ececf1;
      border-radius:12px;
      padding:14px;
      min-width:0;
    }
    .hk-section-title{ font-weight:600; margin-bottom:10px; }
    .hk-daterow{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:10px;
      align-items:end;
      width:100%;
    }
    input[type="date"]{
      width:100%;
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:12px;
      background:#fff;
      color:#111827;
      font-size:14px;
      line-height:1.2;
    }
    .hk-hint{ margin-top:8px; color:#6b7280; font-size:12px; }
    .hk-duration{ margin-top:8px; font-size:13px; color:#111827; font-weight:600; }
    .hk-counters{ display:flex; flex-direction:column; gap:8px; }
    .hk-counter-row{
      display:grid;
      grid-template-columns:40px 1fr auto;
      gap:10px;
      align-items:center;
      border:1px solid #ececf1;
      border-radius:12px;
      padding:12px;
    }
    .hk-count{ font-size:24px; font-weight:800; color:#111827; min-width:28px; text-align:center; }
    .hk-label{ font-weight:700; }
    .hk-sublabel{ color:#6b7280; font-size:12px; }
    .hk-btn{
      width:36px; height:36px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:18px;
      cursor:pointer;
    }
    .hk-btn:disabled{ opacity:.35; cursor:not-allowed; }
    .hk-error{ margin-top:8px; color:#b00020; font-size:14px; }
    .hk-footer{ margin-left:auto; margin-top:8px; }
    .hk-cta{
      padding:12px 18px;
      border-radius:12px;
      border:0;
      background:#154696;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      min-width:140px;
    }
    .hk-cta:hover{ background:#103874; }
    @media (max-width:510px){
      .hk-daterow{ grid-template-columns:1fr; }
      .hk-logo{ height:32px; }
    }
  </style>
</head>

<body>
  <div id="hk-widget">
    <div class="hk-header">
      <div class="hk-titles">
        <!-- Platzhalter, wird per JS überschrieben -->
        <h3 class="hk-title">Skitickets</h3>
        <div class="hk-subtitle">Stunden-, Tages- & Mehrtagestickets</div>
      </div>
      <img class="hk-logo" src="https://www.hochkar.com/portal/dist/images/branding/hochkar/logo.db33c945.png" alt="Hochkar Logo">
    </div>

    <div class="hk-body">
      <div class="hk-section" id="hk-date-section">
        <div class="hk-section-title">Datumsbereich</div>
        <div class="hk-daterow">
          <div>
            <label for="hk-start">Von</label>
            <input type="date" id="hk-start" required>
          </div>
          <div>
            <label for="hk-end">Bis</label>
            <input type="date" id="hk-end" disabled>
          </div>
        </div>
        <div class="hk-hint">Buchbar sind 1–6 Tage. „Bis“ leer lassen, um 1 Tag zu buchen.</div>
        <div class="hk-duration" id="hk-duration">Ausgewählte Dauer: –</div>
      </div>

      <div class="hk-section hk-counters">
        <div class="hk-counter-row">
          <div class="hk-count" id="hk-adults-count">1</div>
          <div>
            <div class="hk-label">Erwachsene</div>
            <div class="hk-sublabel">ab 16 Jahren</div>
          </div>
          <div>
            <button class="hk-btn" id="hk-adults-minus">–</button>
            <button class="hk-btn" id="hk-adults-plus">+</button>
          </div>
        </div>
        <div class="hk-counter-row">
          <div class="hk-count" id="hk-kids-count">0</div>
          <div>
            <div class="hk-label">Kinder</div>
            <div class="hk-sublabel">6–15 Jahre</div>
          </div>
          <div>
            <button class="hk-btn" id="hk-kids-minus" disabled>–</button>
            <button class="hk-btn" id="hk-kids-plus">+</button>
          </div>
        </div>
      </div>

      <div id="hk-error" class="hk-error" style="display:none"></div>
      <div class="hk-footer">
        <button id="hk-submit" class="hk-cta" type="button">Weiter</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const qs   = new URLSearchParams(location.search);
    const LANG = (qs.get('lang') || navigator.language || 'de')
      .toLowerCase()
      .startsWith('en') ? 'en' : 'de';

    const TEXTS = {
      de: {
        title: "Skitickets",
        subtitle: "Stunden-, Tages- & Mehrtagestickets",
        dateSection: "Datumsbereich",
        from: "Von",
        to: "Bis",
        hint: "Buchbar sind 1–6 Tage. „Bis“ leer lassen, um 1 Tag zu buchen.",
        durationPrefix: "Ausgewählte Dauer:",
        day: "Tag",
        days: "Tage",
        adults: "Erwachsene",
        adultsSub: "ab 16 Jahren",
        kids: "Kinder",
        kidsSub: "6–15 Jahre",
        cta: "Weiter",
        errNoStart: "Bitte Startdatum wählen.",
        errDuration: "Bitte Dauer zwischen 1 und 6 Tagen wählen."
      },
      en: {
        title: "Ski tickets",
        subtitle: "Hourly, day & multi-day tickets",
        dateSection: "Date range",
        from: "From",
        to: "To",
        hint: "You can book 1–6 days. Leave “To” empty to book 1 day.",
        durationPrefix: "Selected duration:",
        day: "day",
        days: "days",
        adults: "Adults",
        adultsSub: "from 16 years",
        kids: "Children",
        kidsSub: "6–15 years",
        cta: "Continue",
        errNoStart: "Please select a start date.",
        errDuration: "Please choose a duration between 1 and 6 days."
      }
    };

    const MAX_DAYS = 6;
    const $ = id => document.getElementById(id);

    const elStart      = $("hk-start");
    const elEnd        = $("hk-end");
    const dur          = $("hk-duration");
    const err          = $("hk-error");
    const adultsCount  = $("hk-adults-count");
    const kidsCount    = $("hk-kids-count");
    const kidsMinusBtn = $("hk-kids-minus");

    let adults = 1, kids = 0;

    function applyTranslations() {
      const t = TEXTS[LANG];

      // HTML lang-Attribut setzen (für Screenreader/SEO)
      document.documentElement.lang = LANG;

      document.querySelector(".hk-title").textContent = t.title;
      document.querySelector(".hk-subtitle").textContent = t.subtitle;
      document.querySelector("#hk-date-section .hk-section-title").textContent = t.dateSection;

      document.querySelector('label[for="hk-start"]').textContent = t.from;
      document.querySelector('label[for="hk-end"]').textContent   = t.to;
      document.querySelector(".hk-hint").textContent              = t.hint;

      const rows = document.querySelectorAll(".hk-counter-row");
      // Erwachsene
      rows[0].querySelector(".hk-label").textContent    = t.adults;
      rows[0].querySelector(".hk-sublabel").textContent = t.adultsSub;
      // Kinder
      rows[1].querySelector(".hk-label").textContent    = t.kids;
      rows[1].querySelector(".hk-sublabel").textContent = t.kidsSub;

      $("hk-submit").textContent = t.cta;

      // Initiale Dauer-Anzeige
      dur.textContent = t.durationPrefix + " –";
    }

    function setCount(type, value){
      value = Math.max(0, Math.min(99, value|0));
      if (type === "adults") {
        adults = value;
        adultsCount.textContent = value;
      } else {
        kids = value;
        kidsCount.textContent = value;
        kidsMinusBtn.disabled = value <= 0;
      }
    }

    $("hk-adults-minus").onclick = () => setCount("adults", adults - 1);
    $("hk-adults-plus").onclick  = () => setCount("adults", adults + 1);
    $("hk-kids-minus").onclick   = () => setCount("kids", kids - 1);
    $("hk-kids-plus").onclick    = () => setCount("kids", kids + 1);

    function toISODate(d){ return new Date(d).toISOString().split("T")[0]; }
    function addDaysISO(iso,n){ const dt=new Date(iso); dt.setDate(dt.getDate()+n); return toISODate(dt); }
    function diffDays(s,e){ return Math.round((new Date(e)-new Date(s))/86400000) + 1; }
    function clampDate(v,min,max){
      if(!v) return v;
      if(min && v < min) return min;
      if(max && v > max) return max;
      return v;
    }

    function updateDuration(){
      const t = TEXTS[LANG];
      const s = elStart.value;
      const e = elEnd.value || s;

      if (!s) {
        dur.textContent = t.durationPrefix + " –";
        return;
      }
      const d = diffDays(s, e);
      dur.textContent = `${t.durationPrefix} ${d} ${d === 1 ? t.day : t.days}`;
    }

    function syncConstraints(){
      const s = elStart.value;
      if (!s) {
        elEnd.value = "";
        elEnd.disabled = true;
        updateDuration();
        return;
      }
      elEnd.disabled = false;
      elEnd.min = s;
      elEnd.max = addDaysISO(s, MAX_DAYS - 1);
      elEnd.value = clampDate(elEnd.value || s, elEnd.min, elEnd.max);
      updateDuration();
    }

    ["input","change","blur"].forEach(evt => {
      elStart.addEventListener(evt, syncConstraints);
      elEnd.addEventListener(evt, updateDuration);
    });

    function buildShopUrl(formState){
      const base = (LANG === 'en')
        ? 'https://shop.hochkar.com/en/products/skitickets'
        : 'https://shop.hochkar.com/products/skitickets';

      const url = new URL(base);
      const UTM_DEFAULT = {
        utm_source:'referral',
        utm_medium:'webshop',
        utm_campaign:'hok_wintersaison_start25',
        utm_content:'widget'
      };
      const utms = { ...UTM_DEFAULT };

      ['utm_source','utm_medium','utm_campaign','utm_content'].forEach(k => {
        if (qs.get(k)) utms[k] = qs.get(k);
      });

      Object.entries(utms).forEach(([k,v]) => url.searchParams.set(k,v));
      url.searchParams.set('formState', JSON.stringify(formState));
      return url.toString();
    }

    $("hk-submit").onclick = () => {
      const t = TEXTS[LANG];
      err.style.display = "none";

      const s = elStart.value;
      if (!s) {
        err.textContent = t.errNoStart;
        err.style.display = "block";
        return;
      }
      const e = elEnd.value || s;
      const d = diffDays(s, e);
      if (d < 1 || d > MAX_DAYS) {
        err.textContent = t.errDuration;
        err.style.display = "block";
        return;
      }

      const from = new Date(s + "T00:00:00").toISOString();
      const to   = new Date(e + "T23:59:59.999").toISOString();

      const allocation = [];
      if (adults > 0) allocation.push({kind:"anonymous",quantity:adults,personType:"adult"});
      if (kids   > 0) allocation.push({kind:"anonymous",quantity:kids,personType:"child"});

      const formState = {
        validity:{ from, to },
        allocation:{ kind:"persontype", values:allocation },
        attributes:{ duration:"1d" } // ggf. später dynamisch machen
      };

      window.open(buildShopUrl(formState), "_blank", "noopener");
    };

    // Initial
    applyTranslations();
    setCount("adults", 1);
    setCount("kids", 0);
    updateDuration();
  })();

  // --- Auto-Resize für iFrame ---
  (function(){
    const ROOT=document.getElementById('hk-widget');
    const BODY_PADDING=48;
    function calcHeight(){return Math.ceil(ROOT.getBoundingClientRect().height)+BODY_PADDING;}
    function post(reason){parent.postMessage({type:'HKWIDGET_HEIGHT',height:calcHeight(),reason},'*');}
    window.addEventListener('load',()=>post('load'));
    window.addEventListener('resize',()=>post('resize'));
    const mo=new MutationObserver(()=>{clearTimeout(post._t);post._t=setTimeout(()=>post('mut'),50);});
    mo.observe(ROOT,{subtree:true,childList:true,attributes:true});
    setTimeout(()=>post('delay300'),300);
    setTimeout(()=>post('delay1200'),1200);
  })();
  </script>
</body>
</html>
