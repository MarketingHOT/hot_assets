<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hochkar Buchungs-Widget</title>

  <style>
    /* ---------------------------------------------------------
       Basis & Layout
       --------------------------------------------------------- */
    *, *::before, *::after { box-sizing: border-box; }

    /* Keine feste Höhe für Body/HTML, damit der iFrame nur so hoch
       wird wie nötig (die Höhe messen wir später exakt). */
    body{
      margin:0;
      background:#f4f6f9;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px;               /* => siehe BODY_PADDING im Resize-Script */
    }

    /* ---------------------------------------------------------
       Widget-Container
       --------------------------------------------------------- */
    #hk-widget{
      max-width:720px;
      width:100%;
      background:#fff;
      border:1px solid #e6e6e9;
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    #hk-widget * { box-sizing:border-box; }

    /* Kopfzeile */
    .hk-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
    }
    .hk-title{ margin:0; font-size:22px; font-weight:800; line-height:1.2; }
    .hk-subtitle{ color:#6b7280; font-size:14px; }
    .hk-logo{ height:40px; width:auto; object-fit:contain; }

    /* Body-Bereiche */
    .hk-body{ display:flex; gap:16px; flex-wrap:wrap; min-width:0; }
    .hk-section{
      flex:1 1 300px;
      border:1px solid #ececf1;
      border-radius:12px;
      padding:14px;
      min-width:0;
    }
    .hk-section-title{ font-weight:600; margin-bottom:10px; }

    /* ---------------------------------------------------------
       Datumsauswahl (überlauf-sicher in schmalen Containern)
       --------------------------------------------------------- */
    .hk-daterow{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:10px;
      align-items:end;
      width:100%;
    }
    .hk-datefield{ min-width:0; width:100%; }
    .hk-datefield label{
      display:block;
      font-size:12px;
      color:#6b7280;
      margin:0 0 4px 0;
      line-height:1.2;
    }
    input[type="date"]{
      display:block;
      width:100%;
      max-width:100%;
      padding:10px;
      border:1px solid #d1d5db;
      border-radius:12px;
      background:#fff;
      color:#111827;
      font-size:14px;
      line-height:1.2;
      min-inline-size:0;
      appearance:auto;           /* Theme-Overrides neutralisieren */
      -webkit-appearance:auto;
    }

    .hk-hint{ margin-top:8px; color:#6b7280; font-size:12px; }
    .hk-duration{ margin-top:8px; font-size:13px; color:#111827; font-weight:600; }

    /* ---------------------------------------------------------
       Zähler (Erwachsene / Kinder)
       --------------------------------------------------------- */
    .hk-counters{ display:flex; flex-direction:column; gap:8px; }
    .hk-counter-row{
      display:grid;
      grid-template-columns:40px 1fr auto;
      gap:10px;
      align-items:center;
      border:1px solid #ececf1;
      border-radius:12px;
      padding:12px;
    }
    .hk-count{ font-size:24px; font-weight:800; color:#111827; min-width:28px; text-align:center; }
    .hk-label{ font-weight:700; }
    .hk-sublabel{ color:#6b7280; font-size:12px; }

    .hk-actions{ display:flex; gap:8px; }
    .hk-btn{
      width:36px; height:36px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#fff;
      font-size:18px; line-height:34px;
      text-align:center; cursor:pointer;
    }
    .hk-btn:disabled{ opacity:.35; cursor:not-allowed; }
    .hk-plus{ font-weight:800; }

    .hk-error{ margin-top:8px; color:#b00020; font-size:14px; }
    .hk-footer{ margin-left:auto; margin-top:8px; }

    /* ---------------------------------------------------------
       CTA-Button – HKB Blau
       --------------------------------------------------------- */
    .hk-cta{
      display:inline-block;
      padding:12px 18px;
      border-radius:12px;
      border:0;
      background:#154696;      /* <- gewünschte Farbe */
      color:#fff;
      font-weight:700;
      cursor:pointer;
      min-width:140px;
    }
    .hk-cta:hover{ background:#103874; }   /* etwas dunkler */
    .hk-cta:focus{ outline:2px solid #103874; outline-offset:2px; }

    /* ---------------------------------------------------------
       Responsiv (Viewport & Container)
       --------------------------------------------------------- */
    @media (max-width:510px){
      .hk-daterow{ grid-template-columns:1fr; }
      .hk-logo{ height:32px; }
    }
    #hk-widget.hk-narrow .hk-daterow{ grid-template-columns:1fr; }
    #hk-widget.hk-narrow .hk-logo{ height:32px; }
  </style>
</head>
<body>

  <div id="hk-widget">
    <!-- Kopfbereich -->
    <div class="hk-header">
      <div class="hk-titles">
        <h3 class="hk-title">Skitickets</h3>
        <div class="hk-subtitle">Stunden-, Tages- & Mehrtagestickets</div>
      </div>
      <!-- offizielles Logo von hochkar.com -->
      <img class="hk-logo" src="https://www.hochkar.com/portal/dist/images/branding/hochkar/logo.db33c945.png" alt="Hochkar Logo">
    </div>

    <!-- Hauptbereich -->
    <div class="hk-body">
      <!-- Datumsbereich -->
      <div class="hk-section" id="hk-date-section">
        <div class="hk-section-title">Datumsbereich</div>

        <div class="hk-daterow">
          <div class="hk-datefield">
            <label for="hk-start">Von</label>
            <input type="date" id="hk-start" required>
          </div>
          <div class="hk-datefield">
            <label for="hk-end">Bis</label>
            <input type="date" id="hk-end" placeholder="optional" disabled>
          </div>
        </div>

        <div class="hk-hint">Buchbar sind 1–6 Tage. „Bis“ leer lassen, um 1&nbsp;Tag zu buchen.</div>
        <div class="hk-duration" id="hk-duration">Ausgewählte Dauer: –</div>
      </div>

      <!-- Personen -->
      <div class="hk-section hk-counters">
        <div class="hk-counter-row">
          <div class="hk-count" id="hk-adults-count">1</div>
          <div class="hk-labels">
            <div class="hk-label">Erwachsen</div>
            <div class="hk-sublabel">Alter ab 16&nbsp;Jahren</div>
          </div>
          <div class="hk-actions">
            <button class="hk-btn hk-minus" id="hk-adults-minus" type="button">–</button>
            <button class="hk-btn hk-plus"  id="hk-adults-plus"  type="button">+</button>
          </div>
        </div>

        <div class="hk-counter-row">
          <div class="hk-count" id="hk-kids-count">0</div>
          <div class="hk-labels">
            <div class="hk-label">Kind</div>
            <div class="hk-sublabel">Alter zwischen 6 und 15&nbsp;Jahren</div>
          </div>
          <div class="hk-actions">
            <button class="hk-btn hk-minus" id="hk-kids-minus" type="button" disabled>–</button>
            <button class="hk-btn hk-plus"  id="hk-kids-plus"  type="button">+</button>
          </div>
        </div>
      </div>

      <!-- Fehler & CTA -->
      <div id="hk-error" class="hk-error" style="display:none"></div>
      <div class="hk-footer"><button id="hk-submit" class="hk-cta" type="button">Weiter</button></div>
    </div>
  </div>

  <script>
  (function(){
    /* ---------------------------------------------------------
       Logik: UI, Validierung, Shop-URL
       --------------------------------------------------------- */
    const PRODUCT_URL = "https://shop.hochkar.com/products/skitickets";
    const MAX_DAYS = 6;

    const $ = id => document.getElementById(id);
    const widget = $("hk-widget");
    const dateSection = $("hk-date-section");

    /* Container-Responsive: wenn die Datums-Sektion < 520 px, Einspaltig erzwingen */
    if (typeof ResizeObserver !== "undefined" && dateSection){
      const ro = new ResizeObserver(entries => {
        widget.classList.toggle("hk-narrow", entries[0].contentRect.width <= 520);
      });
      ro.observe(dateSection);
    }

    /* Referenzen */
    const elStart = $("hk-start");
    const elEnd   = $("hk-end");
    const err     = $("hk-error");
    const dur     = $("hk-duration");

    const adultsCount = $("hk-adults-count");
    const kidsCount   = $("hk-kids-count");

    /* Zähler-Status */
    let adults = 1, kids = 0;

    function setCount(type, value){
      value = Math.max(0, Math.min(99, value|0));
      if (type === "adults"){
        adults = value;
        adultsCount.textContent = value;
      } else {
        kids = value;
        kidsCount.textContent = value;
        $("hk-kids-minus").disabled = value <= 0;
      }
    }

    /* Counter-Buttons */
    $("hk-adults-minus").onclick = () => setCount("adults", adults - 1);
    $("hk-adults-plus").onclick  = () => setCount("adults", adults + 1);
    $("hk-kids-minus").onclick   = () => setCount("kids", kids - 1);
    $("hk-kids-plus").onclick    = () => setCount("kids", kids + 1);

    /* Helfer: Differenz Tage inkl. Start/Ende */
    function diffDays(start, end){
      return Math.round((new Date(end) - new Date(start)) / 86400000) + 1;
    }

    /* Anzeige der Dauer aktualisieren */
    function updateDuration(){
      const s = elStart.value;
      const e = elEnd.value || s;
      if (!s){ dur.textContent = "Ausgewählte Dauer: –"; return; }
      const d = diffDays(s, e);
      dur.textContent = `Ausgewählte Dauer: ${d} ${d === 1 ? "Tag" : "Tage"}`;
    }

    /* -------------------------------
       Startdatum geändert:
       - Enddatum aktivieren
       - Grenzen 1–6 Tage setzen
       - Enddatum IMMER auf Start zurücksetzen (=> 1 Tag)
       - Vorhandenen Wert clampen (Sicherheitsnetz)
       ------------------------------- */
    elStart.onchange = () => {
      const s = elStart.value;
      if (!s){
        elEnd.value = "";
        elEnd.disabled = true;
        dur.textContent = "Ausgewählte Dauer: –";
        return;
      }

      elEnd.disabled = false;

      const max = new Date(s);
      max.setDate(max.getDate() + MAX_DAYS - 1);           // s + (MAX_DAYS-1)
      elEnd.min = s;
      elEnd.max = max.toISOString().split("T")[0];

      // WICHTIG: immer zurücksetzen (1 Tag), damit kein „unendlich viele Tage“ möglich ist
      elEnd.value = s;

      // Falls der Browser noch was cacht: hart clampen
      if (elEnd.value < elEnd.min) elEnd.value = elEnd.min;
      if (elEnd.value > elEnd.max) elEnd.value = elEnd.max;

      updateDuration();
    };

    /* Enddatum geändert -> nur Anzeige aktualisieren */
    elEnd.onchange = updateDuration;

    /* CTA klick -> Prüfen & Shop öffnen */
    $("hk-submit").onclick = () => {
      err.style.display = "none";

      const s = elStart.value;
      const e = elEnd.value || s;

      if (!s){
        return showErr("Bitte ein Startdatum wählen.");
      }

      const d = diffDays(s, e);
      if (d < 1 || d > MAX_DAYS){
        return showErr("Bitte eine Dauer zwischen 1 und 6 Tagen wählen.");
      }

      const from = new Date(s + "T00:00:00");
      const to   = new Date(e + "T23:59:59.999");

      const allocation = [];
      if (adults > 0) allocation.push({ kind:"anonymous", quantity:adults, personType:"adult" });
      if (kids   > 0) allocation.push({ kind:"anonymous", quantity:kids,   personType:"child" });

      const formState = {
        validity:   { from: from.toISOString(), to: to.toISOString() },
        allocation: { kind: "persontype", values: allocation },
        attributes: { duration: "1d" }
      };

      window.open(
        PRODUCT_URL + "?formState=" + encodeURIComponent(JSON.stringify(formState)),
        "_blank",
        "noopener"
      );
    };

    function showErr(t){
      err.textContent = t;
      err.style.display = "block";
    }

    /* Default-Zähler */
    setCount("adults", 1);
    setCount("kids", 0);
  })();

  /* ---------------------------------------------------------
     Auto-Resize für iFrame-Einbettung
     - misst NUR die sichtbare Höhe des Widgets (#hk-widget)
     - addiert Außenabstand des Body (24px oben + 24px unten)
     --------------------------------------------------------- */
  (function(){
    var ROOT = document.getElementById('hk-widget');
    var BODY_PADDING = 48; // 24 + 24

    function calcHeight(){
      if (!ROOT) return 820;
      return Math.ceil(ROOT.getBoundingClientRect().height) + BODY_PADDING;
    }

    function post(reason){
      try{
        parent.postMessage(
          { type:'HKWIDGET_HEIGHT', height: calcHeight(), reason: reason||'' },
          '*'
        );
      }catch(e){}
    }

    window.addEventListener('load',   function(){ post('load');   });
    window.addEventListener('resize', function(){ post('resize'); });

    // Wenn sich etwas im Widget verändert (z.B. Fehlermeldung/Dauer),
    // Höhe mit leichtem Debounce aktualisieren.
    var mo = new MutationObserver(function(){
      clearTimeout(post._t);
      post._t = setTimeout(function(){ post('mut'); }, 50);
    });
    mo.observe(ROOT, { subtree:true, childList:true, attributes:true });

    // Sicherheits-Pings (Fonts / Rendering)
    setTimeout(function(){ post('delay300');  }, 300);
    setTimeout(function(){ post('delay1200'); }, 1200);
  })();
  </script>
</body>
</html>
